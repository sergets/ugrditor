<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="xsl/project.xsl"?>
<project xmlns:sxml="http://sergets.ru/sxml">
    <sxml:var name="projid" from="get" value="id"/>
   
    <!-- Заголовок: название проекта, общая информация -->
    <sxml:select 
        tag="descr" entry="project" entry-class="project" attrs="sxml:time sxml:user sxml:visible-to"
        sxml:update="projects" from="projects" where="(&quot;sxml:item-id&quot; = :projid)" uses="projid" sxml:id="descr"/>
        
    <!-- Список точек -->
    <sxml:select
        tag="points" entry="point" entry-class="point" attrs="sxml:time sxml:user cool deep warn lat lon thread marker empty"
        sxml:update="points" from="points" where="(&quot;project&quot; = :projid)" uses="projid" sxml:id="points">
        <sxml:include from="thread.xml?thread={$thread}"/>
    </sxml:select>
        
    <!-- Новости -->
    <sxml:select
        tag="newslist" entry="news" entry-class="news" attrs="sxml:time sxml:user type ref refname" sxml:enumerable="yes"
        sxml:update="news" from="news" where="(&quot;project&quot; = :projid)" order-by="&quot;sxml:item-id&quot;" order="desc" uses="projid" sxml:id="news"/>
        
    <!-- ДЕЙСТВИЯ --> 
    
    <!-- Права на действия — как у проекта -->
    <sxml:var name="pperm">=projects/<sxml:value-of var="projid"/></sxml:var>
    
    <!-- Переименование проекта -->
    <sxml:action name="rename-project" sxml:open-as="pperm">
        <sxml:var name="name" from="post" value="name"/>
        <sxml:var name="pr" from="post" value="pr"/>
        
        <sxml:edit in="projects" id=":pr" uses="pr name">
            <name>:name</name>
        </sxml:edit>
        
        <sxml:update tag="projects"/>
    </sxml:action>
    
    <!-- Смена прав -->
    <sxml:action name="set-project-rights" sxml:open-as="pperm">
        <sxml:var name="rights" from="post" value="rights"/>
        <sxml:var name="pr" from="post" value="pr"/>
        
        <sxml:edit in="projects" id=":pr" uses="pr rights">
            <sxml:open-to>:rights</sxml:open-to>
            <sxml:visible-to>:rights</sxml:visible-to>
        </sxml:edit>
        
        <sxml:update tag="projects"/>
    </sxml:action>
        
    <!-- Добавление точки -->
    <sxml:action returns="newpointid" name="create-point" sxml:open-as="pperm">

        <sxml:var name="lat" from="post" value="lat"/>
        <sxml:var name="lon" from="post" value="lon"/>
        <sxml:var name="pr" from="post" value="pr"/>
        <!--sxml:var name="cool" from="post" value="cool"/>   < !- - Насколько крутая точка: цвет значка - - >
        <sxml:var name="deep" from="post" value="deep"/>   < !- - Были ли уже на месте, всё ли проверили: яркость значка - - >
        <sxml:var name="warn" from="post" value="warn"/>   < !- - Есть ли проблемы: воскл. значок - - >
        <sxml:var name="name" from="post" value="name"/>
        <sxml:var name="comment" from="post" value="comment"/>
        <sxml:var name="q" from="post" value="q"/>
        <sxml:var name="a" from="post" value="a"/-->
        
        <!-- Дбавляем точку -->
        <sxml:insert into="points" uses="lat lon pr" store="newpointid">
            <lat>:lat</lat>
            <lon>:lon</lon>
            <project>:pr</project>
            <empty>'true'</empty>
            <marker>'point11'</marker>
            <sxml:visible-to>'=projects/' || :pr</sxml:visible-to>
            <sxml:open-to>'=projects/' || :pr</sxml:open-to>
        </sxml:insert>

        <!-- Создаём обсуждение -->
        <sxml:insert into="threads" uses="newpointid" store="newthreadid">
            <type>'point'</type>
            <ref>:newpointid</ref>
            <title>null</title>
        </sxml:insert>
        
        <!-- Прикрепляем тему к точке -->
        <sxml:edit in="points" id=":newpointid" uses="newpointid newthreadid">
            <thread>:newthreadid</thread>
        </sxml:edit>

        <sxml:update tag="points"/>
    </sxml:action>

    
    <!-- Редактирование текста и фотографий точки -->
    
    <sxml:action name="edit-point" sxml:open-as="pperm">

        <sxml:var name="p" from="post" value="p"/>
        <sxml:var name="name" from="post" value="name"/>
        <sxml:var name="descr" from="post" value="descr"/>
        <sxml:var name="marker" from="post" value="marker"/>
        <sxml:var name="q" from="post" value="q"/>
        <sxml:var name="photos" from="post" value="photos"/>
        <sxml:var name="projid" from="get" value="id"/>
        
        <sxml:select what="empty" from="points" where="(&quot;sxml:item-id&quot; = :p)" uses="p" store="empty"/>
        <sxml:unless test="empty">
            <sxml:select what="name" from="points" where="(&quot;sxml:item-id&quot; = :p)" uses="p" store="oldname"/>
            <sxml:select what="photos" from="points" where="(&quot;sxml:item-id&quot; = :p)" uses="p" store="oldphotos"/>
            <sxml:select what="descr" from="points" where="(&quot;sxml:item-id&quot; = :p)" uses="p" store="olddesc"/>
            <sxml:select what="q" from="points" where="(&quot;sxml:item-id&quot; = :p)" uses="p" store="oldq"/>
        </sxml:unless>

        <sxml:select what="thread" from="points" where="(&quot;sxml:item-id&quot; = :p)" uses="p" store="trr"/>
        <sxml:edit in="threads" id=":trr" uses="p trr" open-as="pperm">
            <ref>:p</ref>
        </sxml:edit>
        
        <sxml:edit in="points" id=":p" uses="name descr q p marker photos" open-as="pperm">
            <name>:name</name>
            <descr>:descr</descr>
            <q>:q</q>
            <marker>:marker</marker>
            <photos>:photos</photos>
            <empty>null</empty>
        </sxml:edit>

        <sxml:unless test="empty">
            <sxml:unless test="name" equals="oldname">
                <sxml:select what="thread" from="points" where="(&quot;sxml:item-id&quot; = :p)" uses="p" store="threadid"/>
                <sxml:edit in="threads" id=":threadid" uses="name threadid">
                    <title>:name</title>
                </sxml:edit>
            </sxml:unless>
        
            <sxml:unless test="descr" equals="olddesc">
                <sxml:insert into="news" uses="p projid name descr">
                    <type>'editpointdescr'</type>
                    <project>:projid</project>
                    <ref>:p</ref>
                    <refname>:name</refname>
                    <text>:descr</text>
                </sxml:insert>
            </sxml:unless>

            <sxml:unless test="q" equals="oldq">
                <sxml:insert into="news" uses="p projid name q">
                    <type>'editpointq'</type>
                    <project>:projid</project>
                    <ref>:p</ref>
                    <refname>:name</refname>
                    <text>:q</text>
                </sxml:insert>
            </sxml:unless>
            
            <sxml:unless test="photos" equals="oldphotos">
                <sxml:insert into="news" uses="p projid name oldphotos photos">
                    <type>'editpointphotos'</type>
                    <project>:projid</project>
                    <ref>:p</ref>
                    <refname>:name</refname>
                    <text>:oldphotos || ';' || :photos</text>
                </sxml:insert>
            </sxml:unless>
        </sxml:unless>
            
        <sxml:if test="empty">
            <sxml:insert into="news" uses="p projid name descr">
                <type>'newpoint'</type>
                <project>:projid</project>
                <ref>:p</ref>
                <refname>:name</refname>
                <text>:descr</text>
            </sxml:insert>        
        </sxml:if>
        
        <!-- Когда всё получится, обновим все штуки: появилась точка, новость о ней -->
        <sxml:update tag="points"/>
        <sxml:update tag="news"/>
    </sxml:action>
    
    <!-- Перетаскивание точки -->
    
    <sxml:action name="move-point" sxml:open-as="pperm">

        <sxml:var name="p" from="post" value="p"/>
        <sxml:var name="lat" from="post" value="lat"/>
        <sxml:var name="lon" from="post" value="lon"/>

        <sxml:edit in="points" id=":p" uses="lat lon p" open-as="pperm">
            <lat>:lat</lat>
            <lon>:lon</lon>
        </sxml:edit>        
        
        <sxml:update tag="points"/>
        
    </sxml:action>
   
    <!-- Удаление точки -->    
    
    <sxml:action name="delete-point" sxml:open-as="pperm">

        <sxml:var name="p" from="post" value="p"/>

        <sxml:delete from="points" id=":p" uses="p"/>
        
        <sxml:update tag="points"/>        

    </sxml:action>
    
</project>
